# Production environment â€” 3 replicas, higher resources, 2 full backup retention.
# This file is self-contained (bcgov/action-crunchy only reads this one file).
# Structure must match bcgov/action-crunchy chart templates.
global:
  config:
    dbName: soba

crunchy:
  enabled: true
  postgresVersion: 16
  imagePullPolicy: IfNotPresent

  instances:
    name: db
    replicas: 3
    dataVolumeClaimSpec:
      storage: 1Gi
      storageClassName: netapp-block-standard
      walStorage: 1Gi
    requests:
      cpu: 100m
      memory: 256Mi
    replicaCertCopy:
      requests:
        cpu: 1m
        memory: 32Mi

  pgBackRest:
    enabled: true
    backupPath: /backups/prod/cluster/version
    clusterCounter: 2
    retentionFullType: count
    s3:
      enabled: false
    pvc:
      retention: 2
      retentionFullType: count
      fullBackupSchedule: "0 8 * * *"
      incrementalBackupSchedule: "0 0,12 * * *"
      volume:
        accessModes: "ReadWriteOnce"
        storage: 4Gi
        storageClassName: netapp-file-backup
    config:
      requests:
        cpu: 5m
        memory: 32Mi
    repoHost:
      requests:
        cpu: 20m
        memory: 128Mi
    sidecars:
      requests:
        cpu: 5m
        memory: 16Mi
    jobs:
      requests:
        cpu: 20m
        memory: 128Mi

  patroni:
    postgresql:
      pg_hba:
        - "host all all 0.0.0.0/0 md5"
        - "host all all ::/128 md5"
      parameters:
        shared_buffers: 128MB
        wal_buffers: "64kB"
        min_wal_size: 32MB
        max_wal_size: 64MB
        max_slot_wal_keep_size: 128MB
        effective_cache_size: 256MB
        work_mem: 4MB
        maintenance_work_mem: 64MB
        max_connections: "100"
        password_encryption: scram-sha-256
        log_min_duration_statement: 1000ms
        effective_io_concurrency: 20

  proxy:
    enabled: true
    pgBouncer:
      replicas: 2
      requests:
        cpu: 10m
        memory: 64Mi
      maxConnections: 100
      poolMode: transaction
      defaultPoolSize: "20"
      minPoolSize: "2"

  pgmonitor:
    enabled: true
    exporter:
      requests:
        cpu: 10m
        memory: 32Mi
