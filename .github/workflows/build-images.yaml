# Build backend and frontend Docker images for GHCR.
# Reusable via workflow_call.
# Manual runs let devs choose amd64, arm64, or both (e.g. for local development/debugging).
# PRs and pushes to main default to amd64 only (OpenShift).
#
# Use in another workflow:
#
#   jobs:
#     set-vars:
#       outputs:
#         ref: refs/pull/${{ github.event.pull_request.number }}/head
#
#     build:
#       uses: ./.github/workflows/build-images.yaml
#       with:
#         ref: ${{ needs.set-vars.outputs.ref }}
#         platforms: amd64
#       secrets: inherit
#
#     deploy:
#       needs: [set-vars, build]
#       steps:
#         - run: |
#             TAG="sha-${{ needs.build.outputs.short_sha }}"
#             helm upgrade --install ... --set-string global.tag="${TAG}" ...
#
# Outputs: short_sha, image_version
name: Build Images

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch, refs/pull/N/head, or SHA (blank = default branch)"
        required: false
      platforms:
        description: "Architectures to build"
        required: true
        default: amd64-arm64
        type: choice
        options:
          - amd64
          - arm64
          - amd64-arm64
  workflow_call:
    inputs:
      ref:
        description: "Ref to build (e.g. refs/pull/N/head)"
        required: true
        type: string
      platforms:
        description: "amd64, arm64, or amd64-arm64"
        required: false
        default: amd64
        type: string
      image_version:
        description: "Tag suffix (e.g. pr-42, main). Default derived from ref."
        required: false
        type: string
    outputs:
      short_sha:
        value: ${{ jobs.merge.outputs.short_sha }}
      image_version:
        value: ${{ jobs.merge.outputs.image_version }}
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/build-images.yaml"
  push:
    branches: [main]
    paths:
      - "backend/**"
      - "frontend/**"
      - ".github/workflows/build-images.yaml"

env:
  REGISTRY: ghcr.io

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ steps.vars.outputs.ref }}
      platforms: ${{ steps.vars.outputs.platforms }}
      image_version: ${{ steps.vars.outputs.image_version }}
      matrix: ${{ steps.vars.outputs.matrix }}
    steps:
      - name: Set variables
        id: vars
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            REF="${{ github.event.inputs.ref }}"
            PLATFORMS="${{ github.event.inputs.platforms }}"
          elif [ "${{ github.event_name }}" = "workflow_call" ]; then
            REF="${{ inputs.ref }}"
            PLATFORMS="${{ inputs.platforms }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            REF="refs/pull/${{ github.event.pull_request.number }}/head"
            PLATFORMS="amd64"
          else
            REF="${{ github.sha }}"
            PLATFORMS="amd64"
          fi
          if [ -z "$REF" ]; then
            REF="${{ github.ref }}"
          fi
          echo "ref=$REF" >> $GITHUB_OUTPUT
          echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
          # Build matrix based on requested platforms
          MATRIX='{"include":[]}'
          if echo "$PLATFORMS" | grep -q 'amd64'; then
            MATRIX=$(echo "$MATRIX" | jq -c '.include += [
              {"component":"backend","context":"./backend","platform":"linux/amd64","platform_pair":"linux-amd64","runner":"ubuntu-latest"},
              {"component":"frontend","context":"./frontend","platform":"linux/amd64","platform_pair":"linux-amd64","runner":"ubuntu-latest"}
            ]')
          fi
          if echo "$PLATFORMS" | grep -q 'arm64'; then
            MATRIX=$(echo "$MATRIX" | jq -c '.include += [
              {"component":"backend","context":"./backend","platform":"linux/arm64","platform_pair":"linux-arm64","runner":"ubuntu-24.04-arm"},
              {"component":"frontend","context":"./frontend","platform":"linux/arm64","platform_pair":"linux-arm64","runner":"ubuntu-24.04-arm"}
            ]')
          fi
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          if [ "${{ github.event_name }}" = "workflow_call" ] && [ -n "${{ inputs.image_version }}" ]; then
            echo "image_version=${{ inputs.image_version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "image_version=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_call" ]; then
            if echo "$REF" | grep -q 'refs/pull/'; then
              PR_NUM=$(echo "$REF" | sed 's|refs/pull/||;s|/head||')
              echo "image_version=pr-${PR_NUM}" >> $GITHUB_OUTPUT
            else
              echo "image_version=local" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "image_version=main" >> $GITHUB_OUTPUT
          else
            echo "image_version=local" >> $GITHUB_OUTPUT
          fi

  build:
    needs: prepare
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.prepare.outputs.matrix) }}
    runs-on: ${{ matrix.runner }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          platforms: ${{ matrix.platform }}
          labels: |
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ needs.prepare.outputs.image_version }}
          outputs: type=image,name=${{ env.REGISTRY }}/${{ github.repository }}/${{ matrix.component }},push-by-digest=true,name-canonical=true,push=true
          provenance: false
          sbom: false

      - name: Export digest
        run: |
          mkdir -p ${{ runner.temp }}/digests
          digest="${{ steps.build.outputs.digest }}"
          echo "$digest" > "${{ runner.temp }}/digests/${{ matrix.component }}-${{ matrix.platform_pair }}"

      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ matrix.component }}-${{ matrix.platform_pair }}
          path: ${{ runner.temp }}/digests/*
          retention-days: 1

  merge:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
      image_version: ${{ needs.prepare.outputs.image_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Set variables
        id: vars
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: digests
          pattern: digests-*
          merge-multiple: true

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Merge backend
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          IMAGE="ghcr.io/${{ github.repository }}/backend"
          IMAGE_VERSION="${{ needs.prepare.outputs.image_version }}"
          DIGESTS=""
          for f in $(find digests -type f -name 'backend-*' 2>/dev/null); do
            DIGESTS="${DIGESTS} ${IMAGE}@$(cat $f)"
          done
          [ -n "$DIGESTS" ] || { echo "No backend digests"; exit 1; }
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.description=SOBA API backend for form data management" \
            -t ${IMAGE}:sha-${SHORT_SHA} -t ${IMAGE}:${IMAGE_VERSION} ${DIGESTS}
          if [ "$IMAGE_VERSION" = "main" ]; then
            docker buildx imagetools create \
              --annotation "index:org.opencontainers.image.description=SOBA API backend for form data management" \
              -t ${IMAGE}:latest ${DIGESTS}
          fi

      - name: Merge frontend
        run: |
          SHORT_SHA=$(git rev-parse --short HEAD)
          IMAGE="ghcr.io/${{ github.repository }}/frontend"
          IMAGE_VERSION="${{ needs.prepare.outputs.image_version }}"
          DIGESTS=""
          for f in $(find digests -type f -name 'frontend-*' 2>/dev/null); do
            DIGESTS="${DIGESTS} ${IMAGE}@$(cat $f)"
          done
          [ -n "$DIGESTS" ] || { echo "No frontend digests"; exit 1; }
          docker buildx imagetools create \
            --annotation "index:org.opencontainers.image.description=SOBA Next.js frontend for web form builder" \
            -t ${IMAGE}:sha-${SHORT_SHA} -t ${IMAGE}:${IMAGE_VERSION} ${DIGESTS}
          if [ "$IMAGE_VERSION" = "main" ]; then
            docker buildx imagetools create \
              --annotation "index:org.opencontainers.image.description=SOBA Next.js frontend for web form builder" \
              -t ${IMAGE}:latest ${DIGESTS}
          fi
